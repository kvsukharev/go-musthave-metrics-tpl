name: autotests

on:
  pull_request:
  push:
    branches:
      - main
      - 'iter*'

jobs:
  branchtest:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        shell: bash
        run: |
          if [[ -n "$GITHUB_HEAD_REF" ]]; then
            BRANCH="$GITHUB_HEAD_REF"
          else
            BRANCH="${GITHUB_REF##refs/heads/}"
          fi
          if [[ "$BRANCH" == "main" || "$BRANCH" =~ ^iter[0-9]+$ ]]; then
            echo "OK: branch is '$BRANCH'"
          else
            echo "Branch name must match 'iter<number>' or be 'main'. Current: '$BRANCH'"
            exit 1
          fi

  metricstest:
    runs-on: ubuntu-latest
    needs: branchtest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Download autotests binaries
        uses: robinraju/release-downloader@v1.8
        with:
          repository: Yandex-Practicum/go-autotests
          latest: true
          fileName: "*"
          out-file-path: .tools
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup autotest binaries
        run: |
          chmod -R +x "$GITHUB_WORKSPACE/.tools"
          sudo mv "$GITHUB_WORKSPACE/.tools/metricstest_v2" /usr/local/bin/metricstest
          sudo mv "$GITHUB_WORKSPACE/.tools/random" /usr/local/bin/random
          metricstest -h || true
          random help || true

      - name: Build server binary
        run: |
          cd cmd/server
          go build -buildvcs=false -o server

      - name: Build agent binary
        run: |
          cd cmd/agent
          go build -buildvcs=false -o agent

      - name: Run autotests — Iteration 1
        run: |
          metricstest -test.v -test.run '^TestIteration1$' \
            -binary-path=cmd/server/server

      - name: Run autotests — Iteration 2
        run: |
          metricstest -test.v -test.run '^TestIteration2[AB]*$' \
            -source-path=. \
            -agent-binary-path=cmd/agent/agent

      - name: Run autotests — Iteration 3
        run: |
          metricstest -test.v -test.run '^TestIteration3[AB]*$' \
            -source-path=. \
            -agent-binary-path=cmd/agent/agent \
            -binary-path=cmd/server/server

      - name: Run autotests — Iteration 4
        run: |
          SERVER_PORT=$(random unused-port)
          metricstest -test.v -test.run '^TestIteration4$' \
            -source-path=. \
            -agent-binary-path=cmd/agent/agent \
            -binary-path=cmd/server/server \
            -server-port="$SERVER_PORT"